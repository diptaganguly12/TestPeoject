<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Cleanliness Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body {
            background-color: #f8f9fa;
            padding-top: 60px;
        }

        .top-bar {
            background: #2c3e50;
            color: white;
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .analysis-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
        }

        .score-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-good { background-color: var(--success-color); color: white; }
        .status-acceptable { background-color: var(--warning-color); color: black; }
        .status-needs-attention { background-color: var(--danger-color); color: white; }

        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        #imageGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
        }

        #videoElement {
            width: 100%;
            border-radius: 8px;
            background-color: #2c3e50;
        }

        .metric-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .detail-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-tabs .nav-link {
            color: #495057;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: bold;
        }

        .camera-select {
            height: 150px !important;
        }

        .list-group-item {
            margin-bottom: 10px;
            border-radius: 5px !important;
        }

        .btn-group {
            gap: 5px;
        }

        .tab-content {
            padding: 20px;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }

        .camera-status-active {
            color: var(--success-color);
        }

        .camera-status-inactive {
            color: var(--danger-color);
        }
        
        /* Queue styles */
        #queueTable th, #queueTable td {
            vertical-align: middle;
        }
        
        .task-pending {
            background-color: rgba(255, 193, 7, 0.1);
        }
        
        .task-processing {
            background-color: rgba(13, 202, 240, 0.1);
        }
        
        .task-completed {
            background-color: rgba(25, 135, 84, 0.1);
        }
        
        .task-failed {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .task-active {
            animation: pulse 1.5s infinite ease-in-out;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Hospital Cleanliness Analysis Dashboard</h4>
                <div class="d-flex align-items-center gap-4">
                    <div>
                        <i class="fas fa-user-circle me-2"></i>
                        <span id="userLogin">diptaganguly12</span>
                    </div>
                    <div>
                        <i class="fas fa-clock me-2"></i>
                        <span id="currentDateTime">2025-04-28 10:24:54</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Processing Image Analysis...</div>
        </div>

        <!-- Navigation Tabs -->
		
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#upload-section">
                    <i class="fas fa-upload me-2"></i>Upload & Capture
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#cctv-section">
                    <i class="fas fa-video me-2"></i>CCTV Management
                </a>
            </li>
			<!-- Add this to the nav-tabs section -->
			<li class="nav-item">
				<a class="nav-link" data-bs-toggle="tab" href="#summary-section">
					<i class="fas fa-chart-pie me-2"></i>Summary Reports
				</a>
			</li>
        </ul>
		<style>
    .header-info {
        position: fixed;
        top: 0;
        right: 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom-left-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .time-display {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.85rem;
        color: #333;
        background: rgba(45, 63, 228, 0.1);
        padding: 8px 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .time-display i {
        color: #2D3FE4;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: #333;
    }

    .user-info i {
        color: #00C897;
    }

    .logout-btn {
        background: linear-gradient(135deg, #2D3FE4, #00F7FF);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9rem;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(45, 63, 228, 0.2);
    }

    .logout-btn i {
        font-size: 0.8rem;
    }

    .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(45, 63, 228, 0.3);
        background: linear-gradient(135deg, #2D3FE4, #2D3FE4);
    }

    .logout-btn:active {
        transform: translateY(0);
    }

    @media (max-width: 768px) {
        .header-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.8rem;
            width: 100%;
            border-radius: 0;
        }

        .time-display {
            font-size: 0.8rem;
        }
    }
		</style>

		<div class="header-info">
			<div class="time-display">
				<i class="fas fa-clock"></i>
				<span>2025-04-28 10:24:54</span>
			</div>
			<div class="user-info">
				<i class="fas fa-user-circle"></i>
				<span>diptaganguly12</span>
			</div>
			<a href="{{ url_for('logout') }}" class="logout-btn">
				<i class="fas fa-sign-out-alt"></i>
				Logout
			</a>
		</div>

		<!-- Add Font Awesome if not already included -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

        <div class="tab-content">
            <!-- Upload & Capture Section -->
            <div class="tab-pane fade show active" id="upload-section">
                <div class="row g-4 mb-4">
                    <!-- Left Column - Upload Form -->
                    <div class="col-md-6">
                        <div class="analysis-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Image Upload</h5>
                            </div>
                            <div class="card-body">
                                <!-- Replace the existing form in the upload section with this -->
								<form id="uploadForm">
									<div class="mb-3">
										<label for="hospital_name" class="form-label">
											<i class="fas fa-hospital me-2"></i>Hospital
										</label>
										<select class="form-control" id="hospital_name" name="hospital_name" required>
											<option value="">Select hospital</option>
										</select>
									</div>
									<!-- Replace the existing Building dropdown with text input -->
									<div class="mb-3">
										<label for="building" class="form-label">
											<i class="fas fa-building me-2"></i>Building
										</label>
										<input type="text" class="form-control" id="building" name="building" 
											   placeholder="Enter building name" required>
									</div>

									<!-- Replace the existing Floor dropdown with text input -->
									<div class="mb-3">
										<label for="floor" class="form-label">
											<i class="fas fa-layer-group me-2"></i>Floor
										</label>
										<input type="text" class="form-control" id="floor" name="floor" 
											   placeholder="Enter floor number/name" required>
									</div>

									<!-- Replace the existing Category dropdown with text input -->
									<div class="mb-3">
										<label for="category" class="form-label">
											<i class="fas fa-tags me-2"></i>Category
										</label>
										<input type="text" class="form-control" id="category" name="category" 
											   placeholder="Enter category" required>
									</div>
									<div class="mb-3">
										<label for="location" class="form-label">
											<i class="fas fa-map-marker-alt me-2"></i>Specific Location
										</label>
										<input type="text" class="form-control" id="location" name="location" 
											   placeholder="Enter specific location" required>
									</div>
									<div class="mb-3">
										<label for="image" class="form-label">
											<i class="fas fa-image me-2"></i>Select Image
										</label>
										<input type="file" class="form-control" id="image" name="image" 
											   accept="image/*" required>
									</div>
									<button type="submit" class="btn btn-primary w-100">
										<i class="fas fa-upload me-2"></i>Upload and Analyze
									</button>
								</form>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Camera -->
                    <div class="col-md-6">
                        <div class="analysis-card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-camera me-2"></i>Camera Capture</h5>
                            </div>
                            <div class="card-body">
                                <div class="camera-container">
									<video id="videoElement" autoplay playsinline></video>
									<div class="text-center mt-3">
										<div class="btn-group">
											<button id="switchCameraBtn" class="btn btn-primary me-2">
												<i class="fas fa-sync me-2"></i>Switch Camera
											</button>
											<button id="captureBtn" class="btn btn-success">
												<i class="fas fa-camera me-2"></i>Capture Image
											</button>
										</div>
									</div>
								</div>
                                <canvas id="canvas" style="display: none;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Queue Management Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="analysis-card">
                            <div class="card-header bg-info text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Analysis Queue</h5>
                                    <div>
                                        <span class="badge bg-primary" id="queueLength">0</span> tasks in queue
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="queueTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Image</th>
                                                <th>Location</th>
                                                <th>Submitted</th>
                                                <th>Status</th>
                                                <th>Progress</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="queueTableBody">
                                            <!-- Queue items will be displayed here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3" id="emptyQueueMessage">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>No tasks in queue
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CCTV Management Section -->
            <div class="tab-pane fade" id="cctv-section">
                <div class="row g-4">
                    <!-- Left Column - Add Camera Form -->
                    <div class="col-md-4">
                        <div class="analysis-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add Camera</h5>
                            </div>
                            <div class="card-body">
                                <form id="addCameraForm">
                                    <div class="mb-3">
                                        <label class="form-label">Camera Name</label>
                                        <input type="text" class="form-control" name="name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Floor</label>
                                        <input type="text" class="form-control" name="floor" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control" name="location" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">IP Address</label>
                                        <input type="text" class="form-control" name="ip_address" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Username (Optional)</label>
                                        <input type="text" class="form-control" name="username">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Password (Optional)</label>
                                        <input type="password" class="form-control" name="password">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">RTSP URL (Optional)</label>
                                        <input type="text" class="form-control" name="rtsp_url">
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus-circle me-2"></i>Add Camera
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Camera List -->
                    <div class="col-md-8">
                        <div class="analysis-card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Camera List</h5>
                            </div>
                            <div class="card-body">
                                <div id="cameraList" class="list-group">
                                    <!-- Cameras will be listed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Management -->
                        <div class="analysis-card mt-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Schedule Management</h5>
                            </div>
                            <div class="card-body">
                                <form id="addScheduleForm" class="mb-4">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Schedule Name</label>
                                                <input type="text" class="form-control" name="name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Select Cameras</label>
                                                <select multiple class="form-control camera-select" name="cameras" required>
                                                    <!-- Camera options will be populated here -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Frequency (Cron Expression)</label>
                                                <input type="text" class="form-control" name="frequency" 
                                                       placeholder="*/30 * * * *" required>
                                                <small class="text-muted">Example: */30 * * * * (every 30 minutes)</small>
                                            </div>
                                            <button type="submit" class="btn btn-success w-100">
                                                <i class="fas fa-plus-circle me-2"></i>Add Schedule
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                <div id="scheduleList" class="list-group">
                                    <!-- Schedules will be listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
			<!-- Add this after your existing tab-pane divs -->
			<div class="tab-pane fade" id="summary-section">
				<div class="analysis-card">
					<div class="card-header bg-primary text-white">
						<h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Options</h5>
					</div>
					<div class="card-body">
						<div class="row g-3">
							<div class="col-md-3">
								<label class="form-label">Hospital</label>
								<select class="form-control" id="summaryHospital">
									<option value="">All Hospitals</option>
								</select>
							</div>
							<div class="col-md-3">
								<label class="form-label">Status</label>
								<select class="form-control" id="summaryStatus">
									<option value="">All Status</option>
									<option value="Needs Attention">Needs Attention</option>
									<option value="Acceptable">Acceptable</option>
									<option value="Good">Good</option>
								</select>
							</div>
							<div class="col-md-3">
								<label class="form-label">Date Range</label>
								<input type="date" class="form-control" id="summaryDateFrom">
							</div>
							<div class="col-md-3">
								<label class="form-label">To</label>
								<input type="date" class="form-control" id="summaryDateTo">
							</div>
						</div>
						<div class="text-end mt-3">
							<button class="btn btn-primary" onclick="filterSummary()">
								<i class="fas fa-filter me-2"></i>Apply Filter
							</button>
							<button class="btn btn-success" onclick="exportToExcel()">
								<i class="fas fa-file-excel me-2"></i>Export to Excel
							</button>
						</div>
					</div>
				</div>
				<!-- Add Advanced Analytics Section -->
				<div class="row g-4 mt-4">
					<!-- Trend Analysis -->
					<div class="col-md-6">
						<div class="analysis-card">
							<div class="card-header bg-primary text-white">
								<h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Trend Analysis</h5>
							</div>
							<div class="card-body">
								<canvas id="trendChart"></canvas>
							</div>
						</div>
					</div>
					
					<!-- Category Distribution -->
					<div class="col-md-6">
						<div class="analysis-card">
							<div class="card-header bg-primary text-white">
								<h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Category Distribution</h5>
							</div>
							<div class="card-body">
								<canvas id="categoryChart"></canvas>
							</div>
						</div>
					</div>

					<!-- Area Performance -->
					<div class="col-md-12">
						<div class="analysis-card">
							<div class="card-header bg-primary text-white">
								<h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Area Performance Analysis</h5>
							</div>
							<div class="card-body">
								<div class="table-responsive">
									<table class="table table-striped" id="areaPerformanceTable">
										<thead>
											<tr>
												<th>Area</th>
												<th>Total Inspections</th>
												<th>Average Score</th>
												<th>Trend</th>
												<th>Most Common Issues</th>
												<th>Status Distribution</th>
											</tr>
										</thead>
										<tbody id="areaPerformanceBody"></tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Summary Statistics -->
				<div class="row g-4 mt-4">
					<div class="col-md-4">
						<div class="analysis-card text-center">
							<div class="card-body bg-danger text-white rounded">
								<i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
								<h5>Needs Attention</h5>
								<div class="d-flex align-items-center justify-content-center">
									<h2 id="needsAttentionCount" class="mb-0">0</h2>
									<small class="ms-2">areas</small>
								</div>
								<div class="mt-2">
									<small id="needsAttentionPercentage">0%</small>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="analysis-card text-center">
							<div class="card-body bg-warning rounded">
								<i class="fas fa-exclamation fa-2x mb-2"></i>
								<h5>Acceptable</h5>
								<div class="d-flex align-items-center justify-content-center">
									<h2 id="acceptableCount" class="mb-0">0</h2>
									<small class="ms-2">areas</small>
								</div>
								<div class="mt-2">
									<small id="acceptablePercentage">0%</small>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="analysis-card text-center">
							<div class="card-body bg-success text-white rounded">
								<i class="fas fa-check-circle fa-2x mb-2"></i>
								<h5>Good</h5>
								<div class="d-flex align-items-center justify-content-center">
									<h2 id="goodCount" class="mb-0">0</h2>
									<small class="ms-2">areas</small>
								</div>
								<div class="mt-2">
									<small id="goodPercentage">0%</small>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Summary Table -->
				<div class="analysis-card mt-4">
					<div class="card-header bg-info text-white">
						<h5 class="mb-0"><i class="fas fa-table me-2"></i>Detailed Summary</h5>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-striped" id="summaryTable">
								<thead>
									<tr>
										<th>Date & Time</th>
										<th>Hospital</th>
										<th>Building</th>
										<th>Floor</th>
										<th>Category</th>
										<th>Location</th>
										<th>Overall Score</th>
										<th>Status</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody id="summaryTableBody">
									<!-- Data will be populated here -->
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
        </div>

        <!-- Analysis Results -->
        <div class="mt-4">
            <h5 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Analysis Results</h5>
            <div id="imageGrid"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Queue Management System
        class AnalysisQueue {
            constructor() {
                this.queue = new Map();
                this.observers = [];
            }
            
            // Add a task to the queue
            addTask(taskId, metadata) {
                if (!this.queue.has(taskId)) {
                    const task = {
                        id: taskId,
                        metadata: metadata,
                        status: 'pending',
                        progress: 0,
                        added: new Date(),
                        updated: new Date(),
                        error: null
                    };
                    this.queue.set(taskId, task);
                    this.notifyObservers();
                    this.pollTaskStatus(taskId);
                    return task;
                }
                return this.queue.get(taskId);
            }
			
			// Poll for task status
			pollTaskStatus(taskId) {
				const task = this.queue.get(taskId);
				if (!task) {
					return;
				}
				
				// Don't continue polling for completed, failed, or cancelled tasks
				if (task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled') {
					return;
				}
				
				fetch(`/api/analysis-status/${taskId}`)
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							const status = data.data.status;
							const progress = data.data.progress || task.progress;
							
							this.updateTask(taskId, { 
								status: status,
								progress: progress,
								error: data.data.error || null
							});
							
							if (status === 'completed') {
								// Keep completed tasks in queue for 1 minute then remove
								setTimeout(() => {
									this.removeTask(taskId);
								}, 60000);
							} else if (status === 'failed' || status === 'cancelled') {
								// Keep failed or cancelled tasks in queue for 5 minutes then remove
								setTimeout(() => {
									this.removeTask(taskId);
								}, 300000);
							} else {
								// Continue polling if still processing
								setTimeout(() => this.pollTaskStatus(taskId), 2000);
							}
						} else {
							// Check if the error indicates task not found, which could mean it was cancelled
							if (data.error && data.error.includes('not found')) {
								this.updateTask(taskId, { 
									status: 'cancelled',
									progress: 100,
									error: 'Task not found (may have been cancelled)'
								});
								return;
							}
							
							// Retry on other errors
							setTimeout(() => this.pollTaskStatus(taskId), 5000);
						}
					})
					.catch(error => {
						console.error('Error polling task status:', error);
						// Retry on error
						setTimeout(() => this.pollTaskStatus(taskId), 5000);
					});
			}
		}

		// Function to view task details
		function viewTask(taskId) {
			// This creates a modal to view detailed task information
			const task = analysisQueue.getTask(taskId);
			if (!task) {
				showNotification('Task not found', 'danger');
				return;
			}
			
			// Create modal HTML
			const modalId = 'taskModal' + Date.now();
			const modalHTML = `
				<div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Task Details: ${taskId}</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<div class="row">
									<div class="col-md-6">
										<div class="card mb-3">
											<div class="card-header bg-primary text-white">
												<h5 class="mb-0">Image Preview</h5>
											</div>
											<div class="card-body text-center">
												<img src="/uploads/${task.metadata.filename}" 
													 class="img-fluid rounded" style="max-height: 300px;">
											</div>
										</div>
									</div>
									<div class="col-md-6">
										<div class="card mb-3">
											<div class="card-header bg-primary text-white">
												<h5 class="mb-0">Task Information</h5>
											</div>
											<div class="card-body">
												<p><strong>Status:</strong> <span id="${modalId}-status">${getStatusBadge(task.status)}</span></p>
												<p><strong>Added:</strong> ${new Date(task.added).toLocaleString()}</p>
												<p><strong>Last Updated:</strong> ${new Date(task.updated).toLocaleString()}</p>
												<p><strong>Location:</strong> ${task.metadata.hospital_name}, ${task.metadata.building}, ${task.metadata.floor}</p>
												<p><strong>Category:</strong> ${task.metadata.category}</p>
												<p><strong>Priority:</strong> ${task.metadata.priority ? 'High' : 'Normal'}</p>
												${task.error ? `<p><strong>Error:</strong> <span class="text-danger">${task.error}</span></p>` : ''}
											</div>
										</div>
										
										<div class="card">
											<div class="card-header bg-primary text-white">
												<h5 class="mb-0">Actions</h5>
											</div>
											<div class="card-body">
												<div class="progress mb-3" style="height: 20px;">
													<div class="progress-bar ${getProgressBarClass(task.status)}" 
														role="progressbar" style="width: ${task.progress}%">
														${task.progress}%
													</div>
												</div>
												<div class="d-flex gap-2">
													${task.status === 'pending' ? `
														<button class="btn btn-danger" onclick="cancelTask('${taskId}'); document.getElementById('${modalId}-status').innerHTML = '<span class=\'badge bg-warning text-dark\'>Cancelled</span>';">
															<i class="fas fa-times"></i> Cancel
														</button>
														<button class="btn btn-success" onclick="processNow('${taskId}')">
															<i class="fas fa-play"></i> Process Now
														</button>
													` : ''}
												</div>
											</div>
										</div>
									</div>
								</div>
								
								<div class="card mt-3">
									<div class="card-header bg-primary text-white">
										<h5 class="mb-0">Analysis Results</h5>
									</div>
									<div class="card-body" id="${modalId}-results">
										${task.status === 'completed' ? 'Loading results...' : 
										  task.status === 'processing' ? 'Analysis in progress...' : 
										  task.status === 'cancelled' ? 'Analysis was cancelled' :
										  task.status === 'failed' ? `Analysis failed: ${task.error || 'Unknown error'}` : 
										  'Waiting for analysis to begin...'}
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
			`;
			// Append modal to body
			document.body.insertAdjacentHTML('beforeend', modalHTML);
			
			// Show modal
			const modal = new bootstrap.Modal(document.getElementById(modalId));
			modal.show();
			
			// If task is completed, load results
			if (task.status === 'completed') {
				loadTaskResults(taskId, `${modalId}-results`);
			}
			
			// Continue updating if task is still processing
			if (task.status === 'processing' || task.status === 'pending') {
				updateModalTaskStatus(taskId, modalId);
			}
		}
			
			// Append modal to body
			document.body.insertAdjacentHTML('beforeend', modalHTML);
			
			// Show modal
			const modal = new bootstrap.Modal(document.getElementById(modalId));
			modal.show();
			
			// If task is completed, load results
			if (task.status === 'completed') {
				loadTaskResults(taskId, `${modalId}-results`);
			}
			
			// Continue updating if task is still processing
			if (task.status === 'processing' || task.status === 'pending') {
				updateModalTaskStatus(taskId, modalId);
			}
		}
            
            // Update a task in the queue
            updateTask(taskId, updates) {
                if (this.queue.has(taskId)) {
                    const task = this.queue.get(taskId);
                    Object.assign(task, updates, { updated: new Date() });
                    this.queue.set(taskId, task);
                    this.notifyObservers();
                    return task;
                }
                return null;
            }
            
            // Remove a task from the queue
            removeTask(taskId) {
                const removed = this.queue.delete(taskId);
                if (removed) {
                    this.notifyObservers();
                }
                return removed;
            }
            
            // Get all tasks
            getAllTasks() {
                return Array.from(this.queue.values());
            }
            
            // Get a task by ID
            getTask(taskId) {
                return this.queue.get(taskId);
            }
            
            // Register an observer for queue changes
            registerObserver(callback) {
                this.observers.push(callback);
            }
            
            // Notify all observers of queue changes
            notifyObservers() {
                this.observers.forEach(callback => callback(this.getAllTasks()));
            }
            
            // Poll for task status
            pollTaskStatus(taskId) {
                const task = this.queue.get(taskId);
                if (!task || task.status === 'completed' || task.status === 'failed') {
                    return;
                }
                
                fetch(`/api/analysis-status/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const status = data.data.status;
                            const progress = data.data.progress || task.progress;
                            
                            this.updateTask(taskId, { 
                                status: status,
                                progress: progress,
                                error: data.data.error || null
                            });
                            
                            if (status === 'completed') {
                                // Keep completed tasks in queue for 1 minute then remove
                                setTimeout(() => {
                                    this.removeTask(taskId);
                                }, 60000);
                            } else if (status === 'failed') {
                                // Keep failed tasks in queue for 5 minutes then remove
                                setTimeout(() => {
                                    this.removeTask(taskId);
                                }, 300000);
                            } else {
                                // Continue polling if still processing
                                setTimeout(() => this.pollTaskStatus(taskId), 2000);
                            }
                        } else {
                            // Retry on error
                            setTimeout(() => this.pollTaskStatus(taskId), 5000);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling task status:', error);
                        // Retry on error
                        setTimeout(() => this.pollTaskStatus(taskId), 5000);
                    });
            }
        }

        // Initialize the queue
        const analysisQueue = new AnalysisQueue();

        // Update queue UI
        function updateQueueUI(tasks) {
            const queueTableBody = document.getElementById('queueTableBody');
            const queueLength = document.getElementById('queueLength');
            const emptyQueueMessage = document.getElementById('emptyQueueMessage');
            
            // Update queue length
            queueLength.textContent = tasks.length;
            
            // Show/hide empty queue message
            emptyQueueMessage.style.display = tasks.length === 0 ? 'block' : 'none';
            
            // Clear existing rows
            queueTableBody.innerHTML = '';
            
            // Sort tasks by added time (newest first)
            const sortedTasks = [...tasks].sort((a, b) => new Date(b.added) - new Date(a.added));
            
            // Add rows for each task
            sortedTasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = getTaskRowClass(task.status);
                
                // Format timestamp
                const addedTime = new Date(task.added).toLocaleTimeString();
                
                // Get status badge
                const statusBadge = getStatusBadge(task.status);
                
                // Create progress bar
                const progressBar = `
                    <div class="progress" style="height: 15px;">
                        <div class="progress-bar ${getProgressBarClass(task.status)}" 
                             role="progressbar" style="width: ${task.progress}%">
                            ${task.progress}%
                        </div>
                    </div>
                `;
                
                // Create thumbnail
                const thumbnail = `
                    <img src="/uploads/${task.metadata.filename}" 
                         class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover;">
                `;
                
                // Location info
                const location = `
                    ${task.metadata.hospital_name}<br>
                    <small>${task.metadata.building}, ${task.metadata.floor}</small>
                `;
                
                // Actions buttons
                const actions = `
                    <button class="btn btn-sm btn-primary me-1" onclick="viewTask('${task.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="cancelTask('${task.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                row.innerHTML = `
                    <td>${task.id.substring(0, 8)}...</td>
                    <td>${thumbnail}</td>
                    <td>${location}</td>
                    <td>${addedTime}</td>
                    <td>${statusBadge}</td>
                    <td>${progressBar}</td>
                    <td>${actions}</td>
                `;
                
                queueTableBody.appendChild(row);
            });
        }

        // Helper functions for queue UI
        function getTaskRowClass(status) {
            switch(status) {
                case 'completed': return 'table-success';
                case 'failed': return 'table-danger';
                case 'processing': return 'table-info';
                default: return '';
            }
        }
		
		// Function to update task status in modal
		function updateModalTaskStatus(taskId, modalId) {
			fetch(`/api/analysis-status/${taskId}`)
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						const statusElement = document.getElementById(`${modalId}-status`);
						const resultsElement = document.getElementById(`${modalId}-results`);
						
						if (statusElement) {
							statusElement.innerHTML = getStatusBadge(data.data.status);
						}
						
						if (resultsElement) {
							if (data.data.status === 'completed') {
								loadTaskResults(taskId, `${modalId}-results`);
							} else if (data.data.status === 'processing') {
								resultsElement.innerHTML = 'Analysis in progress...';
							} else if (data.data.status === 'cancelled') {
								resultsElement.innerHTML = 'Analysis was cancelled';
							} else if (data.data.status === 'failed') {
								resultsElement.innerHTML = `Analysis failed: ${data.data.error || 'Unknown error'}`;
							}
						}
						
						// If still processing or pending, continue updating
						if (data.data.status === 'processing' || data.data.status === 'pending') {
							setTimeout(() => updateModalTaskStatus(taskId, modalId), 2000);
						}
					}
				})
				.catch(error => console.error('Error updating modal task status:', error));
		}

		// Function to process a task immediately
		function processNow(taskId) {
			fetch(`/api/process-now/${taskId}`, {
				method: 'POST'
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					showNotification('Task processing started', 'success');
					
					// Update task status in the queue
					analysisQueue.updateTask(taskId, { 
						status: 'processing',
						progress: 10
					});
				} else {
					showNotification('Error starting task: ' + data.error, 'danger');
				}
			})
			.catch(error => {
				console.error('Error:', error);
				showNotification('Error starting task', 'danger');
			});
		}

		// Simple notification function
		function showNotification(message, type = 'info') {
			// Create notification element
			const notification = document.createElement('div');
			notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
			notification.style.top = '20px';
			notification.style.right = '20px';
			notification.style.zIndex = '9999';
			notification.innerHTML = `
				${message}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			`;
			
			// Add to document
			document.body.appendChild(notification);
			
			// Auto-remove after 5 seconds
			setTimeout(() => {
				notification.classList.remove('show');
				setTimeout(() => notification.remove(), 500);
			}, 5000);
		}
		
		// Function to update the analysis status display
		function updateAnalysisStatus(taskId) {
			fetch(`/api/analysis-status/${taskId}`)
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						const task = data.data;
						const statusElement = document.getElementById('analysisStatus');
						const resultsElement = document.getElementById('analysisResults');
						
						// Update status display
						if (statusElement) {
							let statusText;
							let statusClass;
							
							switch (task.status) {
								case 'pending':
									statusText = 'Pending';
									statusClass = 'text-secondary';
									break;
								case 'processing':
									statusText = 'Processing...';
									statusClass = 'text-primary';
									break;
								case 'completed':
									statusText = 'Completed';
									statusClass = 'text-success';
									break;
								case 'failed':
									statusText = 'Failed: ' + (task.error || 'Unknown error');
									statusClass = 'text-danger';
									break;
								case 'cancelled':
									statusText = 'Cancelled';
									statusClass = 'text-warning';
									break;
								default:
									statusText = task.status || 'Unknown';
									statusClass = 'text-secondary';
							}
							
							statusElement.innerHTML = `<span class="${statusClass}">${statusText}</span>`;
						}
						
						// Update results display
						if (resultsElement) {
							if (task.status === 'completed') {
								// Fetch the full image data to get analysis results
								fetch(`/api/images`)
									.then(response => response.json())
									.then(imageData => {
										if (imageData.success) {
											// Find the image with matching task ID
											const image = imageData.data.find(img => img.task_id === taskId);
											if (image && image.analysis_results) {
												// Display results
												resultsElement.innerHTML = generateAnalysisResultsHTML(image.analysis_results);
											} else {
												resultsElement.innerHTML = 'No analysis results available';
											}
										}
									})
									.catch(error => {
										console.error('Error fetching image data:', error);
										resultsElement.innerHTML = 'Error loading analysis results';
									});
							} else if (task.status === 'processing') {
								resultsElement.innerHTML = 'Analysis in progress...';
							} else if (task.status === 'cancelled') {
								resultsElement.innerHTML = 'Analysis was cancelled';
							} else if (task.status === 'failed') {
								resultsElement.innerHTML = `Analysis failed: ${task.error || 'Unknown error'}`;
							} else {
								resultsElement.innerHTML = 'Waiting for analysis to begin...';
							}
						}
						
						// If the task is still processing, schedule another update
						if (task.status === 'processing' || task.status === 'pending') {
							setTimeout(() => updateAnalysisStatus(taskId), 5000); // Check again in 5 seconds
						}
					} else {
						const statusElement = document.getElementById('analysisStatus');
						if (statusElement) {
							statusElement.innerHTML = '<span class="text-danger">Error: ' + data.error + '</span>';
						}
						
						const resultsElement = document.getElementById('analysisResults');
						if (resultsElement) {
							resultsElement.innerHTML = 'Could not retrieve analysis status';
						}
					}
				})
				.catch(error => {
					console.error('Error fetching analysis status:', error);
					const statusElement = document.getElementById('analysisStatus');
					if (statusElement) {
						statusElement.innerHTML = '<span class="text-danger">Error: Could not connect to server</span>';
					}
				});
		}
		
		// Function to load task results
		function loadTaskResults(taskId, elementId) {
			fetch(`/api/images`)
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						// Find the image with the matching task ID
						const image = data.data.find(img => img.task_id === taskId);
						if (image && image.analysis_results) {
							// Display results
							document.getElementById(elementId).innerHTML = generateAnalysisResultsHTML(image.analysis_results);
						} else {
							document.getElementById(elementId).innerHTML = 'No analysis results available';
						}
					} else {
						document.getElementById(elementId).innerHTML = 'Error loading results: ' + data.error;
					}
				})
				.catch(error => {
					console.error('Error:', error);
					document.getElementById(elementId).innerHTML = 'Error loading results';
				});
		}

		// Helper function to generate HTML for analysis results
		function generateAnalysisResultsHTML(results) {
			if (!results) return 'No results available';
			
			let html = '<div class="analysis-results">';
			
			// Overall score first
			if (results.overall) {
				const overallScore = results.overall.score;
				const overallStatus = results.overall.status;
				let statusClass;
				
				if (overallStatus === 'Good') {
					statusClass = 'text-success';
				} else if (overallStatus === 'Acceptable') {
					statusClass = 'text-warning';
				} else {
					statusClass = 'text-danger';
				}
				
				html += `
					<div class="overall-score mb-3">
						<h4>Overall Score: <span class="${statusClass}">${overallScore}% (${overallStatus})</span></h4>
					</div>
				`;
			}
			
			// Individual categories
			html += '<div class="categories">';
			['cleanliness', 'hygiene', 'pest_control'].forEach(category => {
				if (results[category]) {
					const score = results[category].score;
					const status = results[category].status;
					let statusClass;
					
					if (status === 'Good') {
						statusClass = 'text-success';
					} else if (status === 'Acceptable') {
						statusClass = 'text-warning';
					} else {
						statusClass = 'text-danger';
					}
					
					html += `
						<div class="category mb-2">
							<h5>${category.charAt(0).toUpperCase() + category.slice(1)}</h5>
							<div class="progress" style="height: 25px;">
								<div class="progress-bar ${statusClass.replace('text-', 'bg-')}" 
									 role="progressbar" 
									 style="width: ${score}%" 
									 aria-valuenow="${score}" 
									 aria-valuemin="0" 
									 aria-valuemax="100">
									${score}%
								</div>
							</div>
							<p class="${statusClass} mt-1">${status}</p>
						</div>
					`;
				}
			});
			html += '</div>';
			
			// Comment if available
			if (results.comment) {
				html += `
					<div class="comment mt-3">
						<h5>Comments:</h5>
						<p>${results.comment}</p>
					</div>
				`;
			}
			
			html += '</div>';
			return html;
		}

		// Helper function to generate HTML for analysis results
		function generateAnalysisResultsHTML(results) {
			if (!results) return 'No results available';
			
			let html = '<div class="analysis-results">';
			
			// Overall score first
			if (results.overall) {
				const overallScore = results.overall.score;
				const overallStatus = results.overall.status;
				let statusClass;
				
				if (overallStatus === 'Good') {
					statusClass = 'text-success';
				} else if (overallStatus === 'Acceptable') {
					statusClass = 'text-warning';
				} else {
					statusClass = 'text-danger';
				}
				
				html += `
					<div class="overall-score mb-3">
						<h4>Overall Score: <span class="${statusClass}">${overallScore}% (${overallStatus})</span></h4>
					</div>
				`;
			}
			
			// Individual categories
			html += '<div class="categories">';
			['cleanliness', 'hygiene', 'pest_control'].forEach(category => {
				if (results[category]) {
					const score = results[category].score;
					const status = results[category].status;
					let statusClass;
					
					if (status === 'Good') {
						statusClass = 'text-success';
					} else if (status === 'Acceptable') {
						statusClass = 'text-warning';
					} else {
						statusClass = 'text-danger';
					}
					
					html += `
						<div class="category mb-2">
							<h5>${category.charAt(0).toUpperCase() + category.slice(1)}</h5>
							<div class="progress" style="height: 25px;">
								<div class="progress-bar ${statusClass.replace('text-', 'bg-')}" 
									 role="progressbar" 
									 style="width: ${score}%" 
									 aria-valuenow="${score}" 
									 aria-valuemin="0" 
									 aria-valuemax="100">
									${score}%
								</div>
							</div>
							<p class="${statusClass} mt-1">${status}</p>
						</div>
					`;
				}
			});
			html += '</div>';
			
			// Comment if available
			if (results.comment) {
				html += `
					<div class="comment mt-3">
						<h5>Comments:</h5>
						<p>${results.comment}</p>
					</div>
				`;
			}
			
			html += '</div>';
			return html;
		}

		// Function to cancel a task
		function cancelTask(taskId) {
			if (confirm('Are you sure you want to cancel this task?')) {
				fetch(`/api/task/${taskId}/cancel`, {
					method: 'POST'
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						// Immediately update the task in the queue to show cancelled status
						analysisQueue.updateTask(taskId, { 
							status: 'cancelled',
							progress: 100,
							error: 'Task was cancelled by user'
						});
						
						showNotification('Task cancelled successfully', 'success');
						
						// Refresh any task details display if viewing the specific task
						const statusElement = document.getElementById('analysisStatus');
						if (statusElement) {
							statusElement.innerHTML = '<span class="text-warning">Cancelled</span>';
						}
						
						const resultsElement = document.getElementById('analysisResults');
						if (resultsElement) {
							resultsElement.innerHTML = 'Analysis was cancelled';
						}
					} else {
						showNotification('Error cancelling task: ' + data.error, 'danger');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					showNotification('Error cancelling task', 'danger');
				});
			}
		}

		// Make sure to add 'cancelled' status to your helper functions
		function getStatusBadge(status) {
			switch(status) {
				case 'completed':
					return '<span class="badge bg-success">Completed</span>';
				case 'failed':
					return '<span class="badge bg-danger">Failed</span>';
				case 'processing':
					return '<span class="badge bg-primary">Processing</span>';
				case 'cancelled':
					return '<span class="badge bg-warning text-dark">Cancelled</span>';
				default:
					return '<span class="badge bg-secondary">Pending</span>';
			}
		}

		function getProgressBarClass(status) {
			switch(status) {
				case 'completed':
					return 'bg-success';
				case 'failed':
					return 'bg-danger';
				case 'processing':
					return 'bg-primary progress-bar-striped progress-bar-animated';
				case 'cancelled':
					return 'bg-warning';
				default:
					return 'bg-secondary';
			}
		}

        function getProgressBarClass(status) {
            switch(status) {
                case 'completed': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'processing': return 'bg-info progress-bar-striped progress-bar-animated';
                default: return 'bg-warning';
            }
        }

        // Task actions
        function viewTask(taskId) {
            const task = analysisQueue.getTask(taskId);
            if (task) {
                // Find and scroll to the card in the image grid
                const card = document.getElementById(`task-${taskId}`);
                if (card) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    card.classList.add('border', 'border-primary', 'shadow-lg');
                    setTimeout(() => {
                        card.classList.remove('border', 'border-primary', 'shadow-lg');
                    }, 3000);
                }
            }
        }

        // Function to cancel a task
		function cancelTask(taskId) {
			if (confirm('Are you sure you want to cancel this task?')) {
				fetch(`/api/task/${taskId}/cancel`, {
					method: 'POST'
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						showNotification('Task cancelled successfully', 'success');
						// Refresh UI as needed
						loadImages(); // or whatever function updates your UI
					} else {
						showNotification('Error cancelling task: ' + data.error, 'danger');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					showNotification('Error cancelling task', 'danger');
				});
			}
		}

		// Function to set priority and optionally run a task immediately
		function setPriorityAndRun(taskId, priority, runImmediately = false) {
			fetch(`/api/task/${taskId}/priority`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					priority: priority,
					run_immediately: runImmediately
				})
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					showNotification(data.message, 'success');
					// Refresh UI as needed
					loadImages(); // or whatever function updates your UI
				} else {
					showNotification('Error setting priority: ' + data.error, 'danger');
				}
			})
			.catch(error => {
				console.error('Error:', error);
				showNotification('Error setting priority', 'danger');
			});
		}

        // Notification function
        function showNotification(message, type = 'info') {
            const container = document.createElement('div');
            container.className = `toast-container position-fixed top-0 end-0 p-3`;
            container.style.zIndex = '1100';
            
            const toast = document.createElement('div');
            toast.className = `toast bg-${type} text-white`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        Notification
                    </strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            container.appendChild(toast);
            document.body.appendChild(container);
            
            const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
            bsToast.show();
            
            // Remove from DOM after hiding
            toast.addEventListener('hidden.bs.toast', () => {
                container.remove();
            });
        }

        // Your existing JavaScript code here
        const pendingAnalyses = new Set();
        function updateDateTime() {
            fetch('/api/system-info')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('currentDateTime').textContent = data.current_time;
                        
                    }
                })
                .catch(error => console.error('Error updating time:', error));
        }

        setInterval(updateDateTime, 1000);
        updateDateTime();
		

        // Camera handling
        const video = document.getElementById('videoElement');
		const canvas = document.getElementById('canvas');
		const captureBtn = document.getElementById('captureBtn');
		const switchCameraBtn = document.getElementById('switchCameraBtn');
		const loadingSpinner = document.getElementById('loadingSpinner');

		let currentStream;
		let facingMode = 'environment'; // Start with back camera

		async function initializeCamera() {
			try {
				// Stop any existing stream
				if (currentStream) {
					currentStream.getTracks().forEach(track => track.stop());
				}

				// Set up camera with current facing mode
				const constraints = {
					video: {
						facingMode: facingMode,
						width: { ideal: 1920 },
						height: { ideal: 1080 }
					}
				};

				// Get new stream
				const stream = await navigator.mediaDevices.getUserMedia(constraints);
				currentStream = stream;
				video.srcObject = stream;
			} catch (error) {
				console.error("Camera error:", error);
				alert("Error accessing camera. Please check permissions.");
			}
		}

		// Switch camera function
		switchCameraBtn.addEventListener('click', () => {
			facingMode = facingMode === 'environment' ? 'user' : 'environment';
			initializeCamera();
		});

		// Initialize camera on page load
		if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
			initializeCamera();
		} else {
			console.error("getUserMedia not supported");
			alert("Your browser does not support camera access");
		}

        function getStatusClass(status) {
            if (!status) return 'status-needs-attention';
            status = status.toLowerCase();
            if (status === 'good') return 'status-good';
            if (status === 'acceptable') return 'status-acceptable';
            return 'status-needs-attention';
        }

        // Add this to both form submit handlers
		document.getElementById('uploadForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			
			try {
				await navigator.permissions.query({ name: 'geolocation' });
				const formData = new FormData(this);
				uploadImage(formData);
			} catch (error) {
				alert('Please enable location services to continue. This is required to verify the capture location.');
			}
		});

		// Also add to capture button click handler
		captureBtn.addEventListener('click', async function() {
            // Get all form values first
			const hospital_name = document.getElementById('hospital_name').value;
			const building = document.getElementById('building').value;
			const floor = document.getElementById('floor').value;
			const category = document.getElementById('category').value;
			const location = document.getElementById('location').value;
			
			// Check if required fields are filled
			if (!hospital_name || !building || !floor || !category || !location) {
				alert('Please fill in all required fields (Hospital, Building, Floor, Category, and Location) before capturing.');
				return;
			}

			try {
				await navigator.permissions.query({ name: 'geolocation' });
				
				canvas.width = video.videoWidth;
				canvas.height = video.videoHeight;
				canvas.getContext('2d').drawImage(video, 0, 0);
				
				canvas.toBlob(function(blob) {
					const formData = new FormData();
					// Use a consistent filename format
					const timestamp = new Date().toISOString().replace(/[:.]/g, '').substring(0, 15);
					const filename = `capture_${timestamp}.jpg`;
					
					formData.append('image', blob, filename);
					formData.append('hospital_name', hospital_name);
					formData.append('building', building);
					formData.append('floor', floor);
					formData.append('category', category);
					formData.append('location', location);
					uploadImage(formData);
				}, 'image/jpeg', 0.95); // Added quality parameter
			} catch (error) {
				alert('Please enable location services to continue. This is required to verify the capture location.');
			}
		});
		// Function to calculate distance between two points using Haversine formula
		function calculateDistance(lat1, lon1, lat2, lon2) {
			const R = 6371; // Earth's radius in kilometers
			const dLat = toRad(lat2 - lat1);
			const dLon = toRad(lon2 - lon1);
			
			const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
					 Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
					 Math.sin(dLon/2) * Math.sin(dLon/2);
			
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
			const distance = R * c;
			
			return distance;
		}

		function toRad(degrees) {
			return degrees * (Math.PI/180);
		}
		
		// Modified uploadImage function to use the queue system
		async function uploadImage(formData) {
			try {
				loadingSpinner.style.display = 'block';
				
				// Get current location
				const locationData = await getCurrentLocation();
				
				// Get selected hospital
				const selectedHospital = document.getElementById('hospital_name').value;
				
				// Verify location with geo-fence
				const isWithinGeoFence = await verifyGeoFence(selectedHospital, locationData.latitude, locationData.longitude);
				
				if (!isWithinGeoFence) {
					throw new Error('Location verification failed. Please ensure you are within 4 km of the hospital location.');
				}
				
				formData.append('geolocation', JSON.stringify(locationData));
				
				const response = await fetch('/api/upload', {
					method: 'POST',
					body: formData
				});
				
				const data = await response.json();
				loadingSpinner.style.display = 'none';
				
				if (data.success) {
					document.getElementById('uploadForm').reset();
					
					// Add to queue system
					analysisQueue.addTask(data.data.task_id, data.data);
					
					// Create pending card in image grid
					const pendingCard = createPendingCard(data.data);
					document.getElementById('imageGrid').insertBefore(pendingCard, document.getElementById('imageGrid').firstChild);
					
					// Show notification
					showNotification('Image uploaded successfully and added to analysis queue', 'success');
				} else {
					throw new Error(data.error || 'Upload failed');
				}
			} catch (error) {
				loadingSpinner.style.display = 'none';
				console.error('Error:', error);
				showNotification('Upload failed: ' + error.message, 'danger');
			}
		}

		async function verifyGeoFence(hospitalName, currentLat, currentLong) {
			try {
				// Fetch hospital location data
				const response = await fetch('/api/hospital-location/' + encodeURIComponent(hospitalName));
				const data = await response.json();
				
				if (!data.success) {
					throw new Error('Failed to fetch hospital location data');
				}
				
				const hospitalLocation = data.data;
				
				// Calculate distance
				const distance = calculateDistance(
					currentLat,
					currentLong,
					hospitalLocation.latitude,
					hospitalLocation.longitude
				);
				
				// Check if within 4 km
				return distance <= 4;
				
			} catch (error) {
				console.error('Geo-fence verification error:', error);
				throw new Error('Location verification failed');
			}
		}

        // Function to get current location
		async function getCurrentLocation() {
			return new Promise((resolve, reject) => {
				if (!navigator.geolocation) {
					reject(new Error('Geolocation is not supported by your browser'));
					return;
				}

				navigator.geolocation.getCurrentPosition(
					(position) => {
						resolve({
							latitude: position.coords.latitude,
							longitude: position.coords.longitude,
							accuracy: position.coords.accuracy,
							timestamp: new Date().toISOString()
						});
					},
					(error) => {
						reject(new Error(`Failed to get location: ${error.message}`));
					},
					{
						enableHighAccuracy: true,
						timeout: 5000,
						maximumAge: 0
					}
				);
			});
		}
		// Create a function to handle pending analyses
		function createPendingCard(metadata) {
			const card = document.createElement('div');
			card.className = 'analysis-card pending-analysis';
			card.id = `task-${metadata.task_id}`;
			
			card.innerHTML = `
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<img src="/uploads/${metadata.filename}" class="preview-image" 
								 onerror="this.src='https://via.placeholder.com/300?text=Image+Not+Found'">
							<div class="mt-3">
								<p><i class="fas fa-hospital me-2"></i>Hospital: ${metadata.hospital_name}</p>
								<p><i class="fas fa-building me-2"></i>Building: ${metadata.building}</p>
								<p><i class="fas fa-stairs me-2"></i>Floor: ${metadata.floor}</p>
								<p><i class="fas fa-tag me-2"></i>Category: ${metadata.category}</p>
								<p><i class="fas fa-map-marker-alt me-2"></i>Location: ${metadata.location}</p>
								<p><i class="fas fa-clock me-2"></i>Time: ${metadata.timestamp}</p>
							</div>
						</div>
						<div class="col-md-6">
							<div class="alert alert-info">
								<div class="d-flex align-items-center">
									<div class="spinner-border spinner-border-sm me-2" role="status">
										<span class="visually-hidden">Loading...</span>
									</div>
									<span>Analysis in progress...</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			`;
			
			return card;
		}

        function loadImages() {
			const imageGrid = document.getElementById('imageGrid');
			imageGrid.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div></div>';

			fetch('/api/images')
				.then(response => response.json())
				.then(response => {
					imageGrid.innerHTML = '';
					
					if (!response.success || !response.data || response.data.length === 0) {
						imageGrid.innerHTML = '<div class="alert alert-info">No images found</div>';
						return;
					}

					// Sort images so pending ones appear first
					const sortedImages = response.data.sort((a, b) => {
						// First sort by pending status
						if (a.status === 'pending' && b.status !== 'pending') return -1;
						if (a.status !== 'pending' && b.status === 'pending') return 1;
						// Then sort by timestamp
						return new Date(b.timestamp) - new Date(a.timestamp);
					});

					sortedImages.forEach(image => {
						const card = createAnalysisCard(image);
						imageGrid.appendChild(card);
						
						// If it's a pending analysis, add it to the queue
						if (image.status === 'pending' && image.task_id) {
							analysisQueue.addTask(image.task_id, image);
						}
					});
				})
				.catch(error => {
					console.error('Error:', error);
					imageGrid.innerHTML = `
						<div class="alert alert-danger">
							<i class="fas fa-exclamation-circle me-2"></i>
							Error loading images: ${error.message}
						</div>
					`;
				});
		}

        function createAnalysisCard(image) {
			const card = document.createElement('div');
			card.className = 'analysis-card';
			
			// Parse location info if available
			const locationInfo = image.geolocation ? JSON.parse(image.geolocation) : null;
			
			// Check if the image is pending or has analysis results
			const isPending = image.status === 'pending' || !image.analysis_results;
			
			// Create the location HTML section
			const locationHtml = locationInfo ? `
				<div class="mt-3">
					<h6><i class="fas fa-map-marker-alt me-2"></i>Capture Location</h6>
					<div class="alert alert-info">
						<small>Latitude: ${locationInfo.latitude.toFixed(6)}</small><br>
						<small>Longitude: ${locationInfo.longitude.toFixed(6)}</small><br>
						<small>Accuracy: ${Math.round(locationInfo.accuracy)}m</small><br>
						<small>Captured: ${new Date(locationInfo.timestamp).toLocaleString()}</small>
						<div class="mt-2">
							<a href="https://www.google.com/maps?q=${locationInfo.latitude},${locationInfo.longitude}" 
							   target="_blank" class="btn btn-sm btn-primary">
								<i class="fas fa-map me-1"></i>View on Map
							</a>
						</div>
					</div>
				</div>
			` : '<div class="alert alert-warning">No location data available</div>';

			// Create the analysis content based on status
			const analysisContent = isPending ? `
				<div class="alert alert-info">
					<div class="d-flex align-items-center">
						<div class="spinner-border spinner-border-sm me-2" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<span>Analysis in progress...</span>
					</div>
				</div>
			` : `
				<div class="metric-details">
					${image.analysis_results ? `
						<div class="mb-3">
							<h6>Overall Score</h6>
							<span class="score-badge ${getStatusClass(image.analysis_results.overall.status)}">
								${image.analysis_results.overall.score}% - ${image.analysis_results.overall.status}
							</span>
						</div>
						<div class="detail-item">
							<strong>Cleanliness:</strong>
							<span class="score-badge ${getStatusClass(image.analysis_results.cleanliness.status)}">
								${image.analysis_results.cleanliness.score}%
							</span>
						</div>
						<div class="detail-item">
							<strong>Hygiene:</strong>
							<span class="score-badge ${getStatusClass(image.analysis_results.hygiene.status)}">
								${image.analysis_results.hygiene.score}%
							</span>
						</div>
						<div class="detail-item">
							<strong>Pest Control:</strong>
							<span class="score-badge ${getStatusClass(image.analysis_results.pest_control.status)}">
								${image.analysis_results.pest_control.score}%
							</span>
						</div>
						<div class="mt-3">
							<h6><i class="fas fa-comment me-2"></i>Analysis Comment</h6>
							<div class="alert alert-info">
								${image.comment || 'No comment available'}
							</div>
						</div>
					` : '<div class="alert alert-warning">Analysis results not available</div>'}
				</div>
			`;

			// Create the status badge
			const statusBadge = isPending ? `
				<span class="badge bg-warning text-dark">
					<i class="fas fa-clock me-1"></i>Pending
				</span>
			` : image.status === 'failed' ? `
				<span class="badge bg-danger">
					<i class="fas fa-exclamation-circle me-1"></i>Failed
				</span>
			` : `
				<span class="badge bg-success">
					<i class="fas fa-check-circle me-1"></i>Completed
				</span>
			`;

			// Assemble the complete card HTML
			card.innerHTML = `
				<div class="card-body">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="mb-0">
							<i class="fas fa-image me-2"></i>Image Analysis
						</h5>
						${statusBadge}
					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="position-relative">
								<img src="/uploads/${image.filename}" class="preview-image" 
									 onerror="this.src='https://via.placeholder.com/300?text=Image+Not+Found'">
								<div class="position-absolute bottom-0 end-0 m-2">
									<button class="btn btn-sm btn-primary" onclick="window.open('/uploads/${image.filename}', '_blank')">
										<i class="fas fa-expand-alt"></i>
									</button>
								</div>
							</div>
							<div class="mt-3">
								<div class="card">
									<div class="card-header bg-primary text-white">
										<i class="fas fa-info-circle me-2"></i>Image Details
									</div>
									<div class="card-body">
										<p><i class="fas fa-hospital me-2"></i>Hospital: ${image.hospital_name}</p>
										<p><i class="fas fa-building me-2"></i>Building: ${image.building}</p>
										<p><i class="fas fa-stairs me-2"></i>Floor: ${image.floor}</p>
										<p><i class="fas fa-tag me-2"></i>Category: ${image.category}</p>
										<p><i class="fas fa-map-marker-alt me-2"></i>Location: ${image.location}</p>
										<p><i class="fas fa-clock me-2"></i>Captured: ${new Date(image.timestamp).toLocaleString()}</p>
										<p><i class="fas fa-user me-2"></i>Uploaded by: diptaganguly12</p>
									</div>
								</div>
								${locationHtml}
							</div>
						</div>
						<div class="col-md-6">
							<div class="card">
								<div class="card-header ${isPending ? 'bg-warning' : 'bg-success'} text-white">
									<i class="fas fa-chart-bar me-2"></i>Analysis Results
									${isPending ? `
										<small class="float-end">
											<i class="fas fa-spinner fa-spin me-1"></i>Processing
										</small>
									` : ''}
								</div>
								<div class="card-body">
									${analysisContent}
								</div>
							</div>
							${image.task_id ? `
								<div class="mt-3">
									<small class="text-muted">
										<i class="fas fa-info-circle me-1"></i>Task ID: ${image.task_id}
									</small>
								</div>
							` : ''}
						</div>
					</div>
				</div>
			`;

			return card;
		}

        // CCTV Management Functions
        function loadCameras() {
            fetch('/api/cameras')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateCameraList(data.data);
                        updateCameraSelect(data.data);
                    }
                })
                .catch(error => console.error('Error loading cameras:', error));
        }

        function updateCameraList(cameras) {
            const cameraList = document.getElementById('cameraList');
            cameraList.innerHTML = '';

            cameras.forEach(camera => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${camera.name}</h5>
                        <p class="card-text">
                            <strong>Floor:</strong> ${camera.floor}<br>
                            <strong>Location:</strong> ${camera.location}<br>
                            <strong>Status:</strong> ${camera.status}
                        </p>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="captureFromCamera('${camera.id}')">
                                <i class="fas fa-camera"></i> Capture
                            </button>
                            <button class="btn btn-success btn-sm" onclick="toggleMonitoring('${camera.id}')">
                                <i class="fas fa-video"></i> Monitor
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCamera('${camera.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                cameraList.appendChild(card);
            });
        }

        function updateCameraSelect(cameras) {
            const selects = document.querySelectorAll('.camera-select');
            selects.forEach(select => {
                select.innerHTML = cameras.map(camera => 
                    `<option value="${camera.id}">${camera.name} (${camera.floor})</option>`
                ).join('');
            });
        }

        function addCamera(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            fetch('/api/cameras', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadCameras();
                    event.target.reset();
                } else {
                    alert('Error adding camera: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function captureFromCamera(cameraId) {
            fetch(`/api/cameras/${cameraId}/capture`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Add to queue system
                    analysisQueue.addTask(data.data.task_id, data.data);
                    loadImages();
                    showNotification('Camera capture initiated and added to queue', 'success');
                } else {
                    showNotification('Capture failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Capture failed: ' + error.message, 'danger');
            });
        }

        function toggleMonitoring(cameraId) {
            const button = event.target.closest('button');
            const isMonitoring = button.classList.contains('active');
            
            fetch(`/api/cameras/${cameraId}/monitor`, {
                method: isMonitoring ? 'DELETE' : 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.classList.toggle('active');
                    button.classList.toggle('btn-success');
                    button.classList.toggle('btn-warning');
                    button.innerHTML = isMonitoring ? 
                        '<i class="fas fa-video"></i> Monitor' : 
                        '<i class="fas fa-video-slash"></i> Stop';
                    showNotification(`Monitoring ${isMonitoring ? 'stopped' : 'started'}`, 'info');
                } else {
                    showNotification('Failed to toggle monitoring: ' + data.error, 'danger');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function deleteCamera(cameraId) {
            if (confirm('Are you sure you want to delete this camera?')) {
                fetch(`/api/cameras/${cameraId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadCameras();
                        showNotification('Camera deleted successfully', 'success');
                    } else {
                        showNotification('Failed to delete camera: ' + data.error, 'danger');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        // Schedule Management Functions
        function loadSchedules() {
            fetch('/api/schedules')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateScheduleList(data.data);
                    }
                })
                .catch(error => console.error('Error loading schedules:', error));
        }
        
        function updateScheduleList(schedules) {
            const scheduleList = document.getElementById('scheduleList');
            scheduleList.innerHTML = '';

            schedules.forEach(schedule => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${schedule.name}</h5>
                        <p class="card-text">
                            <strong>Frequency:</strong> ${schedule.frequency}<br>
                            <strong>Status:</strong> ${schedule.active ? 'Active' : 'Inactive'}<br>
                            <strong>Last Run:</strong> ${schedule.last_run || 'Never'}
                        </p>
                        <div class="btn-group">
                            <button class="btn btn-${schedule.active ? 'warning' : 'success'} btn-sm" onclick="toggleSchedule('${schedule.id}')">
                                <i class="fas fa-${schedule.active ? 'pause' : 'play'}"></i> ${schedule.active ? 'Pause' : 'Activate'}
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSchedule('${schedule.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                scheduleList.appendChild(card);
            });
        }
        
        function addSchedule(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                frequency: formData.get('frequency'),
                cameras: Array.from(event.target.elements.cameras.selectedOptions).map(option => option.value)
            };

            fetch('/api/schedules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadSchedules();
                    event.target.reset();
                    showNotification('Schedule added successfully', 'success');
                } else {
                    showNotification('Error adding schedule: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error adding schedule', 'danger');
            });
        }
        
        function toggleSchedule(scheduleId) {
            fetch(`/api/schedules/${scheduleId}/toggle`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadSchedules();
                    showNotification(`Schedule ${data.data.active ? 'activated' : 'paused'}`, 'success');
                } else {
                    showNotification('Error toggling schedule: ' + data.error, 'danger');
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        function deleteSchedule(scheduleId) {
            if (confirm('Are you sure you want to delete this schedule?')) {
                fetch(`/api/schedules/${scheduleId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadSchedules();
                        showNotification('Schedule deleted successfully', 'success');
                    } else {
                        showNotification('Error deleting schedule: ' + data.error, 'danger');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }
        
        // Add this to your existing JavaScript code
        function loadHospitalData() {
            // Load hospitals
            fetch('/api/hospitals')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const hospitalSelect = document.getElementById('hospital_name');
                        hospitalSelect.innerHTML = '<option value="">Select hospital</option>';
                        data.data.forEach(hospital => {
                            hospitalSelect.innerHTML += `<option value="${hospital}">${hospital}</option>`;
                        });
                    }
                })
                .catch(error => console.error('Error loading hospitals:', error));
        }
        
        let summaryData = []; // Store all summary data

        function loadSummaryData() {
            fetch('/api/images')
                .then(response => response.json())
                .then(response => {
                    if (response.success && response.data) {
                        summaryData = response.data;
                        updateSummaryDropdowns();
                        filterSummary();
                    }
                })
                .catch(error => console.error('Error loading summary:', error));
        }

        function updateSummaryDropdowns() {
            // Update hospital dropdown
            const hospitals = [...new Set(summaryData.map(item => item.hospital_name))];
            const hospitalSelect = document.getElementById('summaryHospital');
            hospitalSelect.innerHTML = '<option value="">All Hospitals</option>';
            hospitals.forEach(hospital => {
                hospitalSelect.innerHTML += `<option value="${hospital}">${hospital}</option>`;
            });
        }

        function filterSummary() {
            const hospital = document.getElementById('summaryHospital').value;
            const status = document.getElementById('summaryStatus').value;
            const dateFrom = document.getElementById('summaryDateFrom').value;
            const dateTo = document.getElementById('summaryDateTo').value;

            let filtered = [...summaryData];

            if (hospital) {
                filtered = filtered.filter(item => item.hospital_name === hospital);
            }
            if (status) {
                filtered = filtered.filter(item => item.analysis_results && item.analysis_results.overall.status === status);
            }
            if (dateFrom) {
                filtered = filtered.filter(item => new Date(item.timestamp) >= new Date(dateFrom));
            }
            if (dateTo) {
                filtered = filtered.filter(item => new Date(item.timestamp) <= new Date(dateTo));
            }

            updateSummaryTable(filtered);
            updateSummaryCounters(filtered);
        }

        function updateSummaryTable(data) {
            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';

            // Filter only completed analyses
            const completedData = data.filter(item => item.analysis_results);

            completedData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.timestamp}</td>
                    <td>${item.hospital_name}</td>
                    <td>${item.building}</td>
                    <td>${item.floor}</td>
                    <td>${item.category}</td>
                    <td>${item.location}</td>
                    <td>${item.analysis_results.overall.score}%</td>
                    <td>
                        <span class="badge ${getStatusClass(item.analysis_results.overall.status)}">
                            ${item.analysis_results.overall.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewDetails('${item.filename}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateSummaryCounters(data) {
            // Filter only completed analyses
            const completedData = data.filter(item => item.analysis_results);
            const total = completedData.length;
            
            if (total === 0) {
                document.getElementById('needsAttentionCount').textContent = 0;
                document.getElementById('acceptableCount').textContent = 0;
                document.getElementById('goodCount').textContent = 0;
                document.getElementById('needsAttentionPercentage').textContent = '0%';
                document.getElementById('acceptablePercentage').textContent = '0%';
                document.getElementById('goodPercentage').textContent = '0%';
                return;
            }
            
            const needsAttention = completedData.filter(item => item.analysis_results.overall.status === 'Needs Attention').length;
            const acceptable = completedData.filter(item => item.analysis_results.overall.status === 'Acceptable').length;
            const good = completedData.filter(item => item.analysis_results.overall.status === 'Good').length;

            // Update counts
            document.getElementById('needsAttentionCount').textContent = needsAttention;
            document.getElementById('acceptableCount').textContent = acceptable;
            document.getElementById('goodCount').textContent = good;

            // Update percentages
            document.getElementById('needsAttentionPercentage').textContent = 
                `${((needsAttention / total) * 100).toFixed(1)}%`;
            document.getElementById('acceptablePercentage').textContent = 
                `${((acceptable / total) * 100).toFixed(1)}%`;
            document.getElementById('goodPercentage').textContent = 
                `${((good / total) * 100).toFixed(1)}%`;

            // Update trend chart
            updateTrendChart(completedData);
            // Update category distribution
            updateCategoryChart(completedData);
            // Update area performance
            updateAreaPerformance(completedData);
        }

        function updateTrendChart(data) {
            // Group data by date
            const dateGroups = {};
            data.forEach(item => {
                const date = item.timestamp.split(' ')[0];
                if (!dateGroups[date]) {
                    dateGroups[date] = {
                        total: 0,
                        sum: 0,
                        needsAttention: 0,
                        acceptable: 0,
                        good: 0
                    };
                }
                dateGroups[date].total++;
                dateGroups[date].sum += item.analysis_results.overall.score;
                switch(item.analysis_results.overall.status) {
                    case 'Needs Attention':
                        dateGroups[date].needsAttention++;
                        break;
                    case 'Acceptable':
                        dateGroups[date].acceptable++;
                        break;
                    case 'Good':
                        dateGroups[date].good++;
                        break;
                }
            });

            const ctx = document.getElementById('trendChart').getContext('2d');
            // Destroy existing chart if it exists
            if (window.trendChart) {
                window.trendChart.destroy();
            }
            
            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(dateGroups),
                    datasets: [{
                        label: 'Average Score',
                        data: Object.values(dateGroups).map(g => g.sum / g.total),
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateCategoryChart(data) {
            // Group by category
            const categoryGroups = {};
            data.forEach(item => {
                if (!categoryGroups[item.category]) {
                    categoryGroups[item.category] = {
                        total: 0,
                        sum: 0
                    };
                }
                categoryGroups[item.category].total++;
                categoryGroups[item.category].sum += item.analysis_results.overall.score;
            });

            const ctx = document.getElementById('categoryChart').getContext('2d');
            // Destroy existing chart if it exists
            if (window.categoryChart) {
                window.categoryChart.destroy();
            }
            
            window.categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categoryGroups),
                    datasets: [{
                        data: Object.values(categoryGroups).map(g => g.sum / g.total),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updateAreaPerformance(data) {
            // Group by area and analyze performance
            const areaStats = {};
            data.forEach(item => {
                const key = `${item.hospital_name}-${item.building}-${item.floor}`;
                if (!areaStats[key]) {
                    areaStats[key] = {
                        name: key,
                        total: 0,
                        scores: [],
                        issues: {},
                        statuses: {
                            'Needs Attention': 0,
                            'Acceptable': 0,
                            'Good': 0
                        }
                    };
                }
                
                areaStats[key].total++;
                areaStats[key].scores.push(item.analysis_results.overall.score);
                areaStats[key].statuses[item.analysis_results.overall.status]++;
                
                // Track issues
                if (item.analysis_results.overall.score < 80) {
                    Object.entries(item.analysis_results).forEach(([key, value]) => {
                        if (key !== 'overall' && value.score < 80) {
                            if (!areaStats[key].issues[key]) {
                                areaStats[key].issues[key] = 0;
                            }
                            areaStats[key].issues[key]++;
                        }
                    });
                }
            });

            const tbody = document.getElementById('areaPerformanceBody');
            tbody.innerHTML = '';

            Object.values(areaStats).forEach(stats => {
                const avgScore = stats.scores.reduce((a, b) => a + b, 0) / stats.total;
                const trend = calculateTrend(stats.scores);
                
                // Get common issues
                const commonIssues = Object.entries(stats.issues)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([issue]) => issue)
                    .join(', ');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${stats.name}</td>
                    <td>${stats.total}</td>
                    <td>${avgScore.toFixed(1)}%</td>
                    <td>
                        <span class="badge ${trend > 0 ? 'bg-success' : trend < 0 ? 'bg-danger' : 'bg-warning'}">
                            ${trend > 0 ? '' : trend < 0 ? '' : ''} ${Math.abs(trend).toFixed(1)}%
                        </span>
                    </td>
                    <td>${commonIssues || 'None'}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-danger" style="width: ${(stats.statuses['Needs Attention'] / stats.total * 100)}%">
                                ${stats.statuses['Needs Attention']}
                            </div>
                            <div class="progress-bar bg-warning" style="width: ${(stats.statuses['Acceptable'] / stats.total * 100)}%">
                                ${stats.statuses['Acceptable']}
                            </div>
                            <div class="progress-bar bg-success" style="width: ${(stats.statuses['Good'] / stats.total * 100)}%">
                                ${stats.statuses['Good']}
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function calculateTrend(scores) {
            if (scores.length < 2) return 0;
            const recentScores = scores.slice(-5);
            const firstHalf = recentScores.slice(0, Math.floor(recentScores.length / 2));
            const secondHalf = recentScores.slice(Math.floor(recentScores.length / 2));
            const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
            const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
            return secondAvg - firstAvg;
        }

        // Update the view details function
        function viewDetails(filename) {
            // Find the image in the grid and scroll to it
            const images = document.querySelectorAll('.analysis-card');
            for (const card of images) {
                const img = card.querySelector('img');
                if (img && img.src.includes(filename)) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Add highlight effect
                    card.classList.add('border', 'border-primary', 'shadow-lg');
                    setTimeout(() => {
                        card.classList.remove('border', 'border-primary', 'shadow-lg');
                    }, 3000);
                    break;
                }
            }
        }

        function exportToExcel() {
            const hospital = document.getElementById('summaryHospital').value;
            const status = document.getElementById('summaryStatus').value;
            const dateFrom = document.getElementById('summaryDateFrom').value;
            const dateTo = document.getElementById('summaryDateTo').value;

            // Create export URL with filters
            const params = new URLSearchParams({
                hospital: hospital || '',
                status: status || '',
                dateFrom: dateFrom || '',
                dateTo: dateTo || ''
            });

            // Trigger download
            window.location.href = `/api/export/summary?${params.toString()}`;
        }

        // Hospital change handler
        document.getElementById('hospital_name').addEventListener('change', function() {
            const hospital = this.value;
            const buildingSelect = document.getElementById('building');
            const floorSelect = document.getElementById('floor');
            const categorySelect = document.getElementById('category');

            // Reset dependent dropdowns
            buildingSelect.innerHTML = '<option value="">Select building</option>';
            floorSelect.innerHTML = '<option value="">Select floor</option>';
            categorySelect.innerHTML = '<option value="">Select category</option>';

            if (hospital) {
                fetch(`/api/buildings/${encodeURIComponent(hospital)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.data.forEach(building => {
                                buildingSelect.innerHTML += `<option value="${building}">${building}</option>`;
                            });
                        }
                    })
                    .catch(error => console.error('Error loading buildings:', error));
            }
        });

        // Building change handler
        document.getElementById('building').addEventListener('change', function() {
            const hospital = document.getElementById('hospital_name').value;
            const building = this.value;
            const floorSelect = document.getElementById('floor');
            const categorySelect = document.getElementById('category');

            // Reset dependent dropdowns
            floorSelect.innerHTML = '<option value="">Select floor</option>';
            categorySelect.innerHTML = '<option value="">Select category</option>';

            if (hospital && building) {
                fetch(`/api/floors/${encodeURIComponent(hospital)}/${encodeURIComponent(building)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.data.forEach(floor => {
                                floorSelect.innerHTML += `<option value="${floor}">${floor}</option>`;
                            });
                        }
                    })
                    .catch(error => console.error('Error loading floors:', error));
            }
        });

        // Floor change handler
        document.getElementById('floor').addEventListener('change', function() {
            const hospital = document.getElementById('hospital_name').value;
            const building = document.getElementById('building').value;
            const floor = this.value;
            const categorySelect = document.getElementById('category');

            // Reset category dropdown
            categorySelect.innerHTML = '<option value="">Select category</option>';

            if (hospital && building && floor) {
                fetch(`/api/categories/${encodeURIComponent(hospital)}/${encodeURIComponent(building)}/${encodeURIComponent(floor)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.data.forEach(category => {
                                categorySelect.innerHTML += `<option value="${category}">${category}</option>`;
                            });
                        }
                    })
                    .catch(error => console.error('Error loading categories:', error));
            }
        });
        
        // Load pending tasks from server
        function loadPendingTasks() {
            fetch('/api/pending-analyses')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        data.data.forEach(task => {
                            analysisQueue.addTask(task.task_id, task);
                        });
                        showNotification(`Loaded ${data.data.length} pending tasks from server`, 'info');
                    }
                })
                .catch(error => console.error('Error loading pending tasks:', error));
        }

        // Add this to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize queue UI updates
            analysisQueue.registerObserver(updateQueueUI);
            
            // Load pending tasks
            loadPendingTasks();
            
            // Load other data
            loadImages();
            loadCameras();
            loadSchedules();
            loadHospitalData();
            loadSummaryData();
            
            // Update time display and user info
            document.querySelectorAll('.time-display span').forEach(span => {
                span.textContent = document.getElementById('currentDateTime').textContent;
            });
            
            document.querySelectorAll('.user-info span').forEach(span => {
                span.textContent = document.getElementById('userLogin').textContent;
            });
            
            // Add event listeners
            document.getElementById('addCameraForm').addEventListener('submit', addCamera);
            document.getElementById('addScheduleForm').addEventListener('submit', addSchedule);
        });
    </script>
</body>
</html>